---
layout: post_with_wisdom_mathjax
title:  "《交互式计算机图形学》复习笔记五-光照"
date:   2016-01-17
categories: jekyll CG
published: true
excerpt: ""
wisdom: 如果你以为用户是白痴，那就只有白痴才用它。 —— 李纳斯·托沃兹（Linus Torvalds），LINUX之父
meta: 
author: 
subImgPath: cg\lighting\
tags: [计算机图形学 computer-graphics cg CG]
---

##光照
{{site.blank}}光是什么？我们不说些很范的概念，甚至情感方面的，比如“光是抚慰心灵的”。有了光，我们的物体才有了影，“光影”不分家。光有强弱的不同，物体不同表面光的强弱表达出了物体的形。影应该没有强弱（有些影比较淡是因为有环境光或者物体表面的反射光参与了进来），但影的存在表达出了物体的依托，也就是位置关系。

###光照基本原理
{{site.blank}}我们在计图研究中，经常使用的光有三种：环境光（ambient）、漫射光（diffuse）、镜面光（specular）。

* 环境光：这种光在真实世界中其实是不存在的，但在计图中必须有的原因在于我们非常有必要给物体整体上个最基本的亮度与轮廓，不然在监视器上就是漆黑一片（如果光照不到的地方），想象一个全封闭的房间，墙是纯黑的，里面有一盏灯，于是整个房间昏昏暗暗，但是如果把墙涂成白色，同样的孤灯下马上就觉得明亮许多，这个整体的亮度差，我们姑且就拿来形容是真实世界的“环境光”，究其真实原因还是白墙对灯光的漫射，是种标准的漫射光。
* 漫射光：漫射光的存在给世界提供了粗略的明暗效果，使得物体出现了基本的形状，想象一下阴天的户外吧，看不见太阳，但外面的东西依然可以辨认，注意观察的话你会发现，这种情况下基本或者根本看不见影子，较远处有2棵树，不熟悉环境的话因为很难判断出孰近孰远。想象到这里你应该能对漫射光有了正确的感性认知。
* 镜面光：就像激光一样，“直来直去”。照在物体上肯定形成影子，镜面光的存在让物体有了鲜明的明暗效果，同时有了依托（影子，让人正确感知位置关系）。回到上面我们想象的场景中，倘若正是个风和日丽的下午，看一下2棵树的影子与太阳的位置，应该就更有依据判断出它们的远近。

###phong模型
{{site.blank}}我们来简单推导下一个被称为phong（冯）光照模型的公式，三种光的强度分别用L加其英语单词首字母做下标表示。

####漫射光贡献

![img0][myPic1]

一束光照射在表面上，如上图中的u（方向相反），由于从微小尺度观察表面基本都是粗糙的，所以这束光被反射到四面八方。实际情况也是反射到了四面八方，但是并不均匀，可能一个方向比较集中些。我们将能均匀反射到四面八方的表面叫做“理想漫反射表面”，而我们计图中也是将所有表面看作理想的漫反射表面这样才能简化问题。根据Lambert定理可知只有光的垂直分量才对物体表面的亮度有贡献，也就是图中OC向量，OC的计算可以用点积进行。所以漫射光对最终光强度的贡献为：

$$L_d^{'}=L_d\hat {\mathbf u} \cdot \hat {\mathbf n}$$

我们分析下$$w$$，它是光从表面的‘背面’射向了O点，如果表面透明，完全需要考虑，不过我们这里只考虑不透明的情况，这种情况下$$w$$光对表面没有任何贡献，观察到对表面不做贡献的所有光线在图中的方向都是与n反向的，于是我们需要调整上面的模型如下：

$$L_d^{'}=L_d  max(\hat {\mathbf u} \cdot \hat {\mathbf n},0)$$

公式到此依然需要解决2个问题：

1. 现在的漫射光模型应该得到的是光线u对表面O的所有光强贡献，但理想的漫射表面是将该贡献强度射向了四面八方，怎么着也不可能是全部的强度射向一个方向。解决这个问题我们只需要给模型加上一个大于0，小于1的参数$$k_d$$，表示所有贡献的百分之多少射向了周围（均匀反射），于是合乎情理；
2. 第二个问题就是光的能量会随着传播距离而衰减（反比于距离的平方，【物理】），因此需要加上距离衰减因子,最基本的想法就是将漫射强度除以表面到光源的距离d的平方，这样距离越远，最终的强度就越小。但在计图大部分实际应用中是将衰减因子写成一个一元二次代数式的形式，就像下面这样（a、b、c为常数）：

$$F=\frac {1}{a+bd+cd^2}$$

这样写的原因在于不至于将距离光源近的物体明暗差距大，而远的物体差距小。究其根本原因是在于我们真实的世界是各种光源、光线（反射光、折射光、漫射光、散射光等等）复杂叠加的结果，而计图中仅仅将光源想象成一个点，将复杂叠加尽量简单化。

> 用点发光体照明一个场景是真实光照效果的一个简单逼近。摘自《计算机图形学》第三版中文。


最终的漫射光模型如下：

$$L_d^{'}=\frac {1}{a+bd+cd^2}k_dL_d  max(\hat {\mathbf u} \cdot \hat {\mathbf n},0)\tag {1.1}$$  

####镜面光贡献
镜面光在推理上与漫射光一样，只是加了额外的“高光系数”（或者叫做“角强度衰减系数”，参考《计算机图形学》）这个参数$$\alpha$$，最终公式见下。

$$L_s^{'}=\frac {1}{a+bd+cd^2}k_sL_s  max(({\hat {\mathbf r} \cdot \hat {\mathbf v}})^\alpha,0)\tag {1.2}$$  

![img1][myPic2]

公式1.2中向量r（reflect）与v（view）分别表示入射光线u针对平面法线n的反射光线与平面点O到观察者的方向向量。$$k_sL_s{\hat {\mathbf r} \cdot \hat {\mathbf v}}$$就是有多少反射光的强度可以进入人眼。由于r与v都是归一化向量，所以$${\hat {\mathbf r} \cdot \hat {\mathbf v}}=\cos \theta$$（$$\theta$$是r与v的夹角）。我们画出$$f(\theta)=(\cos\theta)^\alpha$$这个函数看一下；

![img2][myPic3] 图片来自《交互式计算机图形学》英文版

当$$\alpha=1$$时，函数就是标准的余弦函数（图中显示部分形状），这种情况下，只要$$\theta$$不超过90度，或多或少会有反射光的部分能量射向v方向。此时我们看到的就是明显的渐变过度。当$$\alpha=5$$时，从图中预计（仅仅是预计，不要叫真）在$$\theta=0.3\frac{\pi}{2}$$时，函数f就等于0，这就表示$$0.3\frac{\pi}{2}<\theta<\frac{\pi}{2}$$的时候函数f是0，也就是此时反射光不对v方向有任何光强贡献。来点直观的效果图见下：

![myPic5][myPic5] 图片来自[维基百科][wikiURL1]

图中红框就是高光，高光白亮的地方与周围有明显的边界（而不是渐变过度），这就是明显的$$\alpha>1$$时候的效果，因为在$$\theta$$到达一定角度后戛然而止，于是出现了明显的高光效果。

####环境光贡献
由于环境光随处都在，就是为了整体提高物体的亮度，所以它对最终亮度有全部的贡献，为了统一起见，我们也加上一个系数$$k_a$$;

####整合
最基本的phong光照模型就是这三种光的线性组合，公式见下。因为公式中使用了不符合物理规律的地方（比如距离衰减），所以我们将其称作经验公式。

$$
L=\frac {1}{a+bd+cd^2}(k_dL_d  max(\hat {\mathbf u} \cdot \hat {\mathbf n},0)+ max(({\hat {\mathbf r} \cdot \hat {\mathbf v}})^\alpha,0))+k_aL_a
$$

![myPic4][myPic4] 图片来自[维基百科][wikiURL1]

跟着公式与上面的图像，我们再次进行说明。第一张子图是只有环境光效果，由于处处存在环境光且强度相同，因此没有明暗的变化，仅仅给物体涂上了一层基础亮度与基本的轮廓，让观察者知道那里有个东西。从图中我们明显看不出其表面的形状，直观感觉像是2个哑铃。第二章子图是仅仅有漫射光的情况，我们看到了物体表面的形，但是阴暗的地方与背景融为一体，因为我们没有给物体涂上基本的亮度。第三张子图是只有镜面光的效果，由于$$\alpha$$设置可能比较高，导致我们只能视觉感知到反射光线明显朝向观察者方向的光亮，其他方向一律剔除，这才形成了图中星星斑点。第四张子图就是前三者的组合，他比第一张、第二张整体明亮，因为亮度叠加了。既能看到整体轮廓，又能看到正对表面的形状，还有高光表达物体表面“光滑”“明亮”的物体特征，这样就算完成了一次较好的渲染。

==TBC==



[myPic1]:{{site.basepath}}{{site.imgpath}}{{page.subImgPath}}image_phong_model.jpg "img1"
[myPic2]:{{site.basepath}}{{site.imgpath}}{{page.subImgPath}}image_phong_model2.jpg "img2"
[myPic3]:{{site.basepath}}{{site.imgpath}}{{page.subImgPath}}image_phong_shininess.jpg "img3"
[myPic4]:{{site.basepath}}{{site.imgpath}}{{page.subImgPath}}image_phong_3_lights.jpg "img4"
[myPic5]:{{site.basepath}}{{site.imgpath}}{{page.subImgPath}}image_phong_specular_light.jpg "img5"

[wikiURL1]:https://en.wikipedia.org/wiki/Phong_reflection_model



